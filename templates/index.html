{% extends "base.html" %}

{% block title %}Home - Feminist Zine Text Reuse Analysis{% endblock %}

{% block content %}
<div class="content-grid">
    <!-- Left Column - Project Description -->
    <div class="content-text">
        <h1>TITLE</h1>
        
        <p>description of project</p>
        
        <h2>Research Questions</h2>
        <ul>
            <li>list</li>
            <li>of</li>
            <li>questions</li>
            <li>here</li>
        </ul>
        
        <h2>Methodology</h2>
        <p>explanations of methods</p>
        
        <div id="stats" class="stats-grid" style="display: none;">
            <div class="stat-card">
                <span id="total-matches" class="stat-number">0</span>
                <div class="stat-label">Text Reuse Matches</div>
            </div>
            <div class="stat-card">
                <span id="total-pages" class="stat-number">0</span>
                <div class="stat-label">Pages Analyzed</div>
            </div>
            <div class="stat-card">
                <span id="publications" class="stat-number">0</span>
                <div class="stat-label">Publications</div>
            </div>
            <div class="stat-card">
                <span id="avg-similarity" class="stat-number">0.0</span>
                <div class="stat-label">Avg. Similarity</div>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Geographic Map -->
    <div class="content-viz">
        <h2 style="margin-bottom: 1rem; color: #555;">Geographic Distribution of Publications</h2>
        <div id="loading" class="loading">Loading publication data</div>
        <div id="map-container" class="viz-container"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    // City coordinates for mapping
    const cityCoordinates = {
        'Iowa City, IA': { lat: 41.6612, lon: -91.5302 },
        'Denver, CO': { lat: 39.7392, lon: -104.9903 },
        'Minneapolis, MN': { lat: 44.9778, lon: -93.2650 },
        'Chicago, IL': { lat: 41.8781, lon: -87.6298 },
        'New York, NY': { lat: 40.7128, lon: -74.0060 },
        'Washington, DC': { lat: 38.9072, lon: -77.0369 },
        'San Francisco, CA': { lat: 37.7749, lon: -122.4194 },
        'Los Angeles, CA': { lat: 34.0522, lon: -118.2437 },
        'Boston, MA': { lat: 42.3601, lon: -71.0589 },
        'Philadelphia, PA': { lat: 39.9526, lon: -75.1652 },
        'Honolulu, HI': { lat: 21.3099, lon: -157.8581 },
        'Storrs, CT': { lat: 41.8084, lon: -72.2495 },
        'New Haven, CT': { lat: 41.3083, lon: -72.9279 },
        'Penllyn, PA': { lat: 40.1626, lon: -75.2663 },
        'Arlington, VA': { lat: 38.8816, lon: -77.0910 },
        'Pittsfield, MA': { lat: 42.4501, lon: -73.2453 },
        'Campbell, CA': { lat: 37.2872, lon: -121.9500 },
        'Charlottesville, VA': { lat: 38.0293, lon: -78.4767 },
        'Houston, TX': { lat: 29.7604, lon: -95.3698 },
        'Portland, OR': { lat: 45.5152, lon: -122.6784 },
        'Tucson, AZ': { lat: 32.2226, lon: -110.9747 },
        'Buffalo, NY': { lat: 42.8864, lon: -78.8784 },
        'Toledo, OH': { lat: 41.6528, lon: -83.5379 },
        'New Orleans, LA': { lat: 29.9511, lon: -90.0715 }
    };

    // Load and visualize data
    Promise.all([
        fetch('/api/metadata').then(response => response.json())
    ])
    .then(([metadata]) => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stats').style.display = 'grid';
        
        updateStats(metadata);
        createMapVisualization(metadata);
    })
    .catch(error => {
        console.error('Error loading data:', error);
        document.getElementById('loading').textContent = 'Error loading data';
    });
    
    function updateStats(metadata) {
        const totalPages = metadata.length;
        const publications = [...new Set(metadata.map(m => m.publication_name))].length;
        
        document.getElementById('total-pages').textContent = totalPages.toLocaleString();
        document.getElementById('publications').textContent = publications;
        // Remove reuse_data related stats since you're not fetching that data
        document.getElementById('total-matches').textContent = '0';
        document.getElementById('avg-similarity').textContent = '0';
    }
    
    function createMapVisualization(metadata) {
        // Group publications by location
        const locationData = {};
        
        metadata.forEach(page => {
            const location = page.location;
            const publication = page.publication_name;
            
            if (!location || !publication) return;
            
            if (!locationData[location]) {
                locationData[location] = {
                    publications: new Set(),
                    pageCount: 0,
                    details: []
                };
            }
            
            locationData[location].publications.add(publication);
            locationData[location].pageCount++;
            locationData[location].details.push({
                publication: publication,
                date: page.issue_date,
                volume: page.volume,
                number: page.number
            });
        });
        
        // Prepare map data
        const lats = [];
        const lons = [];
        const texts = [];
        const sizes = [];
        const colors = [];
        
        const pubColors = {
            "AintIAWoman": '#e74c3c',              // Red
            "BigMammaRag": '#3498db',              // Blue  
            "DoItNow": '#2ecc71',                  // Green
            "GoldFlower": '#f39c12',               // Orange
            "All She Wrote": '#9b59b6',            // Purple
            "All Together Journal": '#34495e',      // Dark blue-gray
            "At the Foot of the Mountain": '#e67e22', // Dark orange
            "Atalanta": '#1abc9c',                 // Turquoise
            "Aurora": '#f1c40f',                   // Yellow
            "Awake & Move": '#95a5a6',             // Gray
            "Belles Lettres": '#8e44ad',           // Dark purple
            "Berkshire Women's News": '#16a085',    // Dark turquoise
            "Between Our Selves": '#c0392b',        // Dark red
            "Bitch": '#d35400',                    // Dark orange-red
            "Blue Lantern": '#2980b9',             // Medium blue
            "Bottomfish Blues": '#7f8c8d',         // Blue-gray
            "Boxcar": '#27ae60',                   // Dark green
            "Breakthrough": '#e85a4f',             // Bright red-orange
            "Catalyst": '#9c88ff',                 // Light purple
            "Change": '#ff6b6b',                   // Light red
            "Change is Gonna Come": '#4ecdc4',      // Light teal
            "Changing Woman": '#45b7d1',           // Sky blue
            "Clarion": '#f9ca24',                  // Bright yellow
            "Common Ground": '#6c5ce7',            // Medium purple
            "Connections": '#a29bfe',              // Lavender
            "Coyote Howls": '#fd79a8',             // Pink
            "Cries from Cassandra": '#00b894',     // Teal
            "Distaff": '#e17055',                  // Coral
            "default": '#bdc3c7'                   // Light gray for unknown
        };
        
        Object.entries(locationData).forEach(([location, data]) => {
            const coords = cityCoordinates[location];
            if (!coords) return;
            
            const publications = Array.from(data.publications);
            const primaryPub = publications[0];
            
            lats.push(coords.lat);
            lons.push(coords.lon);
            texts.push(`${location}<br>${publications.join(', ')}<br>${data.pageCount} pages`);
            sizes.push(Math.max(15, Math.min(50, data.pageCount * 2)));
            colors.push(pubColors[primaryPub] || '#95a5a6');
        });
        
        const mapTrace = {
            type: 'scattergeo',
            locationmode: 'USA-states',
            lat: lats,
            lon: lons,
            text: texts,
            mode: 'markers',
            marker: {
                size: sizes,
                color: colors,
                line: {
                    color: 'white',
                    width: 2
                },
                sizemode: 'diameter'
            },
            hovertemplate: '<b>%{text}</b><extra></extra>'
        };
        
        const layout = {
            geo: {
                scope: 'usa',
                projection: {
                    type: 'albers usa'
                },
                showland: true,
                landcolor: 'rgb(243, 243, 243)',
                coastlinecolor: 'rgb(204, 204, 204)',
            },
            height: 600,
            margin: { t: 20, b: 20, l: 20, r: 20 }
        };
        
        Plotly.newPlot('map-container', [mapTrace], layout, {responsive: true});
    }
</script>
{% endblock %}