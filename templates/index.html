{% extends "base.html" %}

{% block title %}Home - Feminist Zine Text Reuse Analysis{% endblock %}

{% block content %}
<div class="content-grid">
    <!-- Left Column - Project Description -->
    <div class="content-text">
        <h1>Feminist Zine Text Reuse</h1>
        
        <p>description of project</p>
        
        <h2>Research Questions</h2>
        <ul>
            <li>list</li>
            <li>of</li>
            <li>questions</li>
            <li>here</li>
        </ul>
        
        <h2>Methodology</h2>
        <p>explanations of methods</p>
        
        <div id="stats" class="stats-grid">
            <div class="stat-card">
                <span id="total-publications" class="stat-number">29</span>
                <div class="stat-label">Publications</div>
            </div>
            <div class="stat-card">
                <span id="total-locations" class="stat-number">24</span>
                <div class="stat-label">Cities</div>
            </div>
            <div class="stat-card">
                <span id="date-range" class="stat-number">1970-1997</span>
                <div class="stat-label">Years Active</div>
            </div>
            <div class="stat-card">
                <span id="total-issues" class="stat-number">340</span>
                <div class="stat-label">Total Issues</div>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Geographic Map -->
    <div class="content-viz">
        <h2 style="margin-bottom: 1rem; color: #555;">Geographic Distribution of Publications</h2>
        
        <!-- Year Filter Controls -->
        <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
            <h4 style="margin: 0 0 0.5rem 0; color: #555;">Filter by Year Range</h4>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <label style="font-weight: bold;">Start Year:</label>
                <input type="range" id="startYear" min="1970" max="1997" value="1970" 
                       style="flex: 1;" oninput="updateYearFilter()">
                <span id="startYearValue">1970</span>
                
                <label style="font-weight: bold;">End Year:</label>
                <input type="range" id="endYear" min="1970" max="1997" value="1997" 
                       style="flex: 1;" oninput="updateYearFilter()">
                <span id="endYearValue">1997</span>
                
                <button onclick="resetYearFilter()" style="padding: 0.25rem 0.5rem; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Reset</button>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.9em; color: #666;">
                Showing <span id="filteredCount">29</span> of 29 publications
            </div>
        </div>
        
        <div id="map-container" class="viz-container"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    // Publication data from zinepub_metadata.csv
    const publications = [
            {name: "Ain't I A Woman?", location: "Iowa City, IA", years: "1970-1974", issues: 31, startYear: 1970, endYear: 1974},
            {name: "All She Wrote", location: "Honolulu, HI", years: "1982-1986", issues: 15, startYear: 1982, endYear: 1986},
            {name: "All Together Journal", location: "Chicago, IL", years: "1972-1972", issues: 1, startYear: 1972, endYear: 1972},
            {name: "At the Foot of the Mountain", location: "Minneapolis, MN", years: "1976-1976", issues: 1, startYear: 1976, endYear: 1976},
            {name: "Atalanta", location: "Storrs, CT", years: "1975-1975", issues: 1, startYear: 1975, endYear: 1975},
            {name: "Aurora", location: "New Haven, CT", years: "1979-1984", issues: 9, startYear: 1979, endYear: 1984},
            {name: "Awake & Move", location: "Penllyn, PA", years: "1971-1971", issues: 2, startYear: 1971, endYear: 1971},
            {name: "Belles Lettres", location: "Arlington, VA", years: "1985-1990", issues: 20, startYear: 1985, endYear: 1990},
            {name: "Berkshire Women's News", location: "Pittsfield, MA", years: "1984-1986", issues: 3, startYear: 1984, endYear: 1986},
            {name: "Between Our Selves", location: "Washington, DC", years: "1985-1985", issues: 3, startYear: 1985, endYear: 1985},
            {name: "Big Mamma Rag", location: "Denver, CO", years: "1973-1997", issues: 107, startYear: 1973, endYear: 1997},
            {name: "Bitch", location: "Campbell, CA", years: "1986-1987", issues: 3, startYear: 1986, endYear: 1987},
            {name: "Blue Lantern", location: "Charlottesville, VA", years: "1977-1977", issues: 1, startYear: 1977, endYear: 1977},
            {name: "Bottomfish Blues", location: "New York, NY", years: "1987-1990", issues: 4, startYear: 1987, endYear: 1990},
            {name: "Boxcar", location: "San Francisco, CA", years: "1977-1978", issues: 2, startYear: 1977, endYear: 1978},
            {name: "Breakthrough", location: "Houston, TX", years: "1976-1985", issues: 3, startYear: 1976, endYear: 1985},
            {name: "Catalyst", location: "Chicago, IL", years: "1980-1980", issues: 4, startYear: 1980, endYear: 1980},
            {name: "Change", location: "San Francisco, CA", years: "1973-1973", issues: 1, startYear: 1973, endYear: 1973},
            {name: "Change is Gonna Come", location: "San Francisco, CA", years: "1971-1971", issues: 2, startYear: 1971, endYear: 1971},
            {name: "Changing Woman", location: "Portland, OR", years: "1972-1975", issues: 2, startYear: 1972, endYear: 1975},
            {name: "Clarion", location: "Tucson, AZ", years: "1984-1984", issues: 2, startYear: 1984, endYear: 1984},
            {name: "Common Ground", location: "Buffalo, NY", years: "1978-1984", issues: 43, startYear: 1978, endYear: 1984},
            {name: "Common Woman", location: "Winooski, VT", years: "1978-1984", issues: 28, startYear: 1978, endYear: 1984},
            {name: "Connections", location: "Toledo, OH", years: "1980-1983", issues: 23, startYear: 1980, endYear: 1983},
            {name: "Coyote Howls", location: "San Francisco, CA", years: "1977-1979", issues: 5, startYear: 1977, endYear: 1979},
            {name: "Cries from Cassandra", location: "Chicago, IL", years: "1973-1973", issues: 1, startYear: 1973, endYear: 1973},
            {name: "Distaff", location: "New Orleans, LA", years: "1973-1973", issues: 1, startYear: 1973, endYear: 1973},
            {name: "Do It NOW", location: "Los Angeles, CA", years: "1973-1977", issues: 8, startYear: 1973, endYear: 1977},
            {name: "Gold Flower", location: "Minneapolis, MN", years: "1972-1978", issues: 14, startYear: 1972, endYear: 1978}
        ];

    // City coordinates for mapping
        const cityCoordinates = {
            'Iowa City, IA': { lat: 41.6612, lon: -91.5302 },
            'Chicago, IL': { lat: 41.8781, lon: -87.6298 },
            'Minneapolis, MN': { lat: 44.9778, lon: -93.2650 },
            'New York, NY': { lat: 40.7128, lon: -74.0060 },
            'San Francisco, CA': { lat: 37.7749, lon: -122.4194 },
            'Los Angeles, CA': { lat: 34.0522, lon: -118.2437 },
            'Washington, DC': { lat: 38.9072, lon: -77.0369 },
            'Denver, CO': { lat: 39.7392, lon: -104.9903 },
            'Honolulu, HI': { lat: 21.3099, lon: -157.8581 },
            'Storrs, CT': { lat: 41.8084, lon: -72.2495 },
            'New Haven, CT': { lat: 41.3083, lon: -72.9279 },
            'Penllyn, PA': { lat: 40.1626, lon: -75.2663 },
            'Arlington, VA': { lat: 38.8816, lon: -77.0910 },
            'Pittsfield, MA': { lat: 42.4501, lon: -73.2453 },
            'Campbell, CA': { lat: 37.2872, lon: -121.9500 },
            'Charlottesville, VA': { lat: 38.0293, lon: -78.4767 },
            'Houston, TX': { lat: 29.7604, lon: -95.3698 },
            'Portland, OR': { lat: 45.5152, lon: -122.6784 },
            'Tucson, AZ': { lat: 32.2226, lon: -110.9747 },
            'Buffalo, NY': { lat: 42.8864, lon: -78.8784 },
            'Toledo, OH': { lat: 41.6528, lon: -83.5379 },
            'New Orleans, LA': { lat: 29.9511, lon: -90.0715 },
            'Winooski, VT': { lat: 44.4897, lon: -73.1817 },
            'Cambell, CA': { lat: 37.2872, lon: -121.9500 }
        };

    // Filter publications by year range
    function filterPublicationsByYear(startYear, endYear) {
        return publications.filter(pub => {
            // A publication is included if its active years overlap with the filter range
            return pub.endYear >= startYear && pub.startYear <= endYear;
        });
    }

    // Create map visualization
    function createMapVisualization(filteredPublications = publications) {
        // Filter out publications without known locations
        const validPublications = filteredPublications.filter(pub => 
            pub.location !== 'Unknown' && cityCoordinates[pub.location]
        );
        
        const lats = [];
        const lons = [];
        const texts = [];
        const colors = [];
        
        // Color palette for different publications
        const pubColors = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', 
            '#1abc9c', '#e67e22', '#f1c40f', '#95a5a6', '#8e44ad',
            '#16a085', '#c0392b', '#d35400', '#2980b9', '#7f8c8d',
            '#27ae60', '#e85a4f', '#9c88ff', '#ff6b6b', '#4ecdc4'
        ];
        
        // Group by location to handle jittering
        const locationGroups = {};
        validPublications.forEach(pub => {
            if (!locationGroups[pub.location]) {
                locationGroups[pub.location] = [];
            }
            locationGroups[pub.location].push(pub);
        });
        
        Object.entries(locationGroups).forEach(([location, pubs]) => {
            const coords = cityCoordinates[location];
            if (!coords) return;
            
            pubs.forEach((pub, index) => {
                // Add jitter for multiple publications in same city
                const jitterAmount = 0.5; // degrees
                const angle = (index * 2 * Math.PI) / pubs.length;
                const jitterLat = pubs.length > 1 ? coords.lat + jitterAmount * Math.cos(angle) : coords.lat;
                const jitterLon = pubs.length > 1 ? coords.lon + jitterAmount * Math.sin(angle) : coords.lon;
                
                lats.push(jitterLat);
                lons.push(jitterLon);
                texts.push(`<b>${pub.name}</b><br>Location: ${location}<br>Years: ${pub.years}<br>Issues: ${pub.issues}`);
                colors.push(pubColors[publications.indexOf(pub) % pubColors.length]);
            });
        });
        
        const mapTrace = {
            type: 'scattergeo',
            locationmode: 'USA-states',
            lat: lats,
            lon: lons,
            text: texts,
            mode: 'markers',
            marker: {
                size: 20,
                color: colors,
                line: {
                    color: 'white',
                    width: 2
                },
                sizemode: 'diameter'
            },
            hovertemplate: '%{text}<extra></extra>'
        };
        
        const layout = {
            geo: {
                scope: 'usa',
                projection: {
                    type: 'albers usa'
                },
                showland: true,
                landcolor: 'rgb(243, 243, 243)',
                coastlinecolor: 'rgb(204, 204, 204)',
            },
            height: 600,
            margin: { t: 20, b: 20, l: 20, r: 20 }
        };
        
        Plotly.newPlot('map-container', [mapTrace], layout, {responsive: true});
    }

    // Update year filter
    function updateYearFilter() {
        const startYear = parseInt(document.getElementById('startYear').value);
        const endYear = parseInt(document.getElementById('endYear').value);
        
        // Ensure start year is not greater than end year
        if (startYear > endYear) {
            document.getElementById('startYear').value = endYear;
            return;
        }
        
        // Update display values
        document.getElementById('startYearValue').textContent = startYear;
        document.getElementById('endYearValue').textContent = endYear;
        
        // Filter and update map
        const filteredPublications = filterPublicationsByYear(startYear, endYear);
        document.getElementById('filteredCount').textContent = filteredPublications.length;
        
        createMapVisualization(filteredPublications);
    }

    // Reset year filter
    function resetYearFilter() {
        document.getElementById('startYear').value = 1970;
        document.getElementById('endYear').value = 1997;
        updateYearFilter();
    }

    // Initialize map and controls when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateYearFilter();
    });
</script>
{% endblock %}